---
title: "Gather habitat maps and process to 1 km BC"
author: "*Compiled on `r date()` by `r Sys.info()['user']`*"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_depth: 3
    toc_float: yes
    number_sections: true
    theme: cerulean
    highlight: haddock
    includes: 
      in_header: '~/github/src/templates/ohara_hdr.html'
  pdf_document:
    toc: true
---

``` {r setup, echo = TRUE, message = FALSE, warning = FALSE}

knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, fig.height = 4, fig.width = 6)

# library(raster)
library(terra)
library(oharac)
library(data.table)
library(tidyverse)
library(here)
source(here('common_fxns.R'))
```

``` {r helper function and rasts}
anx_root <- function(f = '', ...) { 
  ### create file path to git-annex dir for project
  f <- paste(f, ..., sep = '/')
  f <- stringr::str_replace_all(f, '\\/+', '/')
  f_anx <- sprintf('/home/shares/ohi/git-annex/%s', f)
  return(f_anx)
}
ocean_bc <- rast(here('_spatial/ocean_bc_1km.tif'))
```

# Summary

Update certain habitat maps, with newer available data; aggregate and reproject to bc 1 km resolution.  See also `1_setup/stressors/0_get_seaice.Rmd`

# Data

From Mel, issue: https://github.com/mapping-marine-spp-vuln/issues/issues/26

> The updated coral and seagrass habitat maps are here:
> 
> * home/shares/ohi/git-annex/land-based/wastewater/habitat/habitat_rasters/seagrass.tif
> * home/shares/ohi/git-annex/land-based/wastewater/habitat/habitat_rasters/coral.tif
> 
> The methods and description of data are in this issue: [OHI-Science/wastewater_issues#26 (comment)](https://github.com/OHI-Science/wastewater_issues/issues/26#issuecomment-664698472)
> 
> If you want simple (and definitely better), I would just use these.
> 
> However, there does appear to be even newer data. But they are not yet formatted into raster data. And, there is saltmarsh and kelp data as well.
> 
> Here are some paths to potentially newer data:
> 
> * coral <- raster("/home/shares/ohi/git-annex/globalprep/hab_coral/v2021/int/py_coral_rast.tif") 
>     * raster, but I don't think the data are extracted at as high a resolution as I did
> * kelp <- raster("/home/shares/ohi/git-annex/globalprep/hab_kelp/v2021/int/py_kelp_rast.tif") 
>     * raster, but I don't think the data are extracted at as high a resolution as I did
> * saltmarsh <- raster("/home/shares/ohi/git-annex/globalprep/hab_saltmarsh/v2021/int") 
>     * shapefiles
> * seagrass <- raster("/home/shares/ohi/git-annex/globalprep/hab_seagrass/v2021/int") 
>     * shapefiles
>     * NOTE: v2019/int/py_seagrass_rast.tif does exist! use that!

Coral data citation:

* UNEP-WCMC, WorldFish Centre, WRI, TNC (2018). Global distribution of coral reefs, compiled from multiple sources including the Millennium Coral Reef Mapping Project. Version 4.0, updated by UNEP-WCMC. Includes contributions from IMaRSUSF and IRD (2005), IMaRS-USF (2005) and Spalding et al. (2001). Cambridge (UK): UNEP World Conservation Monitoring Centre. URL: http://data.unepwcmc. org/datasets/1

## Sleuthing for files

(all in `/home/shares/ohi/git-annex/globalprep/`)

* Corals: High res combined coral raster here: 
    * `hab_coral/v2019/int/combined_coral_pt_py_adjusted_high_res.tif`
    * excluded from arctic analysis!
* Seagrasses: High res seagrass rasters here:
    * `hab_seagrass/v2019/int/pt_seagrass_rast_high_res.tif`
    * `hab_seagrass/v2019/int/py_seagrass_rast_high_res.tif`
* Kelp: 934 m raster here:
    * `hab_kelp/v2021/int/py_kelp_rast.tif`
* Saltmarsh: 934m raster here:
    * `hab_saltmarsh/v2019/int/py_saltmarsh_rast.tif`

# Methods

Examine each new source and compare to those from Halpern 2019 habitats.

## Coral reef

Excluded from arctic analysis: no warm-water reef building corals!

```{r corals compare results across methods, eval = FALSE}
coral_ww  <- rast(anx_root('land-based/wastewater/habitat/habitat_rasters/coral.tif')) %>%
  project(ocean_bc)
coral_ohi <- rast(anx_root('globalprep/hab_coral/v2021/int/py_coral_rast.tif')) %>%
  project(ocean_bc)
coral_chi <- rast(here('_data/habitat_maps/deprecated/coral_reef_chi2019.tif'))
  ### already reprojected

### all NA values!
```

## Seagrasses

Seagrasses also have high res rasters for both points and polygons.  Because of the issue with coral points raster, let's only use the polygons raster.  First let's examine estimated coverage based on the wastewater project, OHI 2019, and CHI.

```{r}
sg_ww  <- rast(anx_root('land-based/wastewater/habitat/habitat_rasters/seagrass.tif')) %>%
  project(ocean_bc)
sg_ohi <- rast(anx_root('globalprep/hab_seagrass/v2019/int/py_seagrass_rast.tif')) %>%
  project(ocean_bc)
sg_chi <- rast(here('_data/habitat_maps/deprecated/seagrass_chi2019.tif'))
### already projected!

res_ww <- res(sg_ww) / 1000
cover_chi <- sum(values(sg_chi) * 1, na.rm = TRUE)      ### 0 km^2
cover_ohi <- sum(values(sg_ohi) * res_ww^2, na.rm = TRUE) ### 27 km^2
cover_ww  <- sum(values(sg_ww) * res_ww^2, na.rm = TRUE)  ### 228 km^2
```

The half-km wastewater method again results in a significantly higher value than the CHI (based on older data) or OHI (based on same data) methods.  

```{r seagrass ensemble}
sg_outf <- here('_data/habitat_maps/seagrass_updated.tif')
if(!file.exists(sg_outf)) {
  sg_hires <- rast(anx_root('globalprep/hab_seagrass/v2019/int/py_seagrass_rast_high_res.tif'))
  ### resolution 467 m
  
  message('... Aggregating hi res seagrass by factor of 2x to ~ 1km resolution...')
  r_sum <- aggregate(sg_hires, fact = 2, fun = sum, na.rm = TRUE)
  r_mean <- r_sum / 4
  
  message('... Projecting seagrass raster to 1 km bc...')
  out_r <- project(r_mean, ocean_bc) %>%
    mask(ocean_bc) %>%
    setNames('seagrass')
  
  writeRaster(out_r, sg_outf, overwrite = TRUE)
}
sg_r <- rast(sg_outf)
sg_cover <- sum(values(sg_r), na.rm = TRUE) ### 10.54 km^2
```

Again, quite close to the OHI method in total coverage, but that method may balance out gaps in coverage with overestimates of coverage in other cells.

## Kelp forest

This was not calculated for the wastewater project, so let's just use the updated OHI layer.  It is at the 934 m resolution, rather than high res.

```{r kelp}
kelp_outf <- here('_data/habitat_maps/kelp_updated.tif')
if(!file.exists(kelp_outf)) {
  kelp_ohi_raw <- rast(anx_root('globalprep/hab_kelp/v2021/int/py_kelp_rast.tif'))
  # sum(values(kelp_ohi_raw), na.rm = TRUE) ### 1607511
  
  message('... Projecting kelp raster to 1 km bc...')
  out_r <- project(kelp_ohi_raw, ocean_bc, method = 'near') %>%
    mask(ocean_bc) %>%
    setNames('kelp')
  
  writeRaster(out_r, kelp_outf, overwrite = TRUE)
  # sum(values(out_r), na.rm = TRUE) ### 178496 km^2
}
```

## Salt marsh

This was not calculated for the wastewater project, so let's just use the updated OHI layer.

```{r salt marsh}
sm_outf <- here('_data/habitat_maps/salt_marsh_updated.tif')
if(!file.exists(sm_outf)) {
  sm_ohi_raw <- rast(anx_root('globalprep/hab_saltmarsh/v2019/int/py_saltmarsh_rast.tif'))
  # sum(values(sm_ohi_raw), na.rm = TRUE) ### 1607511
  
  message('... Projecting saltmarsh raster to 1 km bc...')
  out_r <- project(sm_ohi_raw, ocean_bc, method = 'near') %>%
    mask(ocean_bc) %>%
    setNames('salt_marsh')
  
  writeRaster(out_r, sm_outf, overwrite = TRUE)
  # sum(values(out_r), na.rm = TRUE) ### 1040
}
```
